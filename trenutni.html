<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justin Time - moj broj</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- JQuery-->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!--custom css-->
    <link rel="stylesheet" type="text/css" href="css/JT.css">

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>

    <!--font awesome-->

    <script src="https://use.fontawesome.com/75c0c19277.js"></script>

</head>
<body>
<div>

    <div id="navigacija"></div>
<div class="container" id="redPodaci">
    <h2>Moj red</h2>

    <div class="row">
        <div class="col-sm-6 col-md-4">
            <div class="thumbnail">
                <div class="caption">
                    <h3 style="position: absolute; top: 2px; padding-bottom: 15px; font-size: 20px;"><b>{{nazivUstanove}}</b> - {{red.name}}</h3>
                    <button v-if="uRedu" type="button" class="btn btn-primary" style="position: absolute; top: 10px; right: 30px;" @click="ukloni"><i class="fa fa-times" aria-hidden="true" style="font-size: 1.6em"></i>
                    </button>
                    <div style="display: inline-block; margin-right: 20px; margin-left: 15px;">
                        <p style="font-size: 6em; text-align: left; color: indigo; margin-top: 45px">
                            <b v-if="uRedu">{{brojLjudi + 1}}</b>
                            <button v-else class="btn btn-primary"><i class="fa fa-sign-in" aria-hidden="true" style="font-size: 6em;" @click="rezerviraj"></i></button>
                        </p>
                    </div>

                   <div style="display: inline-block;">
                    <p style="text-align: right;font-size: 20px;"><b><i class="fa fa-hourglass-start" aria-hidden="true" style="font-size: 22px"></i></b> {{brojLjudi * 5}} minuta <br>
                       Trenutni broj: {{brojLjudi}}</div>

                </div>
            </div>
        </div>
    </div>



    </div>
</div>
</div>

<div id="footer"></div>

<script>

    var preloader = '<div class="loader loader-default"></div>';
    $('body').append(preloader);

    // pronalazi GET parametre iz url-a
    $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results==null){
            return null;
        }
        else{
            return results[1] || 0;
        }
    };


    var redPodaci = new Vue({
        el: '#redPodaci',
        data: {
            nazivUstanove : "MUP",
            idUstanove : "",
            idReda : "",
            red : [],
            brojLjudi : "",
            uRedu : false

        },
        methods: {

            rezerviraj : function () {
                var app = this;
                var mail = localStorage.getItem("mail");
                var url = 'https://justin-time.herokuapp.com/queue/addUser/';
                url+= this.idUstanove;
                url+="/" + this.idReda + "/" +mail;
                url += "?access_token=" + localStorage.getItem("token");
                $.ajax({
                    method: "POST",
                    contentType: 'application/json',
                    dataType: "json",
                    cache: true,
                    url: url,
                    data: {
                        //"access_token" : localStorage.getItem("token")
                    },
                    statusCode : {
                        409: function () {
                            alert("Već ste u tom redu");
                        }
                    }
                }).done(function( data ) {
                    console.log(data);
                    app.uRedu = true;
                    app.brojLjudi++;
                    localStorage.setItem(app.idReda, true);

                }).fail(function(jqxhr, textStatus, error) {
                    console.log( textStatus + " " + error);
                });

            },
            ukloni : function () {
                var app = this;
                var mail = localStorage.getItem("mail");
                var url = 'https://justin-time.herokuapp.com/queue/removeUser/';
                url+= this.idUstanove;
                url+="/" + this.idReda + "/" +mail;
                url += "?access_token=" + localStorage.getItem("token");
                $.ajax({
                    method: "DELETE",
                    contentType: 'application/json',
                    dataType: "json",
                    cache: true,
                    url: url,
                    data: {
                        //"access_token" : localStorage.getItem("token")
                    }
                }).done(function( data ) {
                    console.log(data);
                    app.uRedu = false;
                    app.brojLjudi--;
                    localStorage.setItem(app.idReda, false);
                }).fail(function(jqxhr, textStatus, error) {
                    console.log( textStatus + " " + error);
                });
            }
        },
        created: function () {
            var url = 'https://justin-time.herokuapp.com/facility/';
            var idUstanove = $.urlParam('ustanova_id');//izvući iz adrese GET
            if(idUstanove == null) {
                //nije proslijeđen id ustanove, vrati na popis ustanova
                //window.location = "ustanova.html";
            }

            url += idUstanove;

            $(".loader").addClass("is-active");//ručno animiraj preloader

            var app = this;
            $.ajax({
                method: "GET",
                contentType: 'application/json',
                dataType: "json",
                cache: true,
                url: url,
                data: {
                    //"access_token" : localStorage.getItem("token")
                }
            }).done(function( data ) {
                $(".loader").removeClass("is-active");
                console.log(data);
                app.idUstanove = data.id;
                app.nazivUstanove = data.name;
                var redovi = data.queues;
                app.idReda = $.urlParam('red_id');
                app.uRedu = localStorage.getItem(app.idReda);
                for(var i = 0; i<data.queues.length;i++) {
                    if(data.queues[i].id == app.idReda) app.red = data.queues[i];
                }
                var url = 'https://justin-time.herokuapp.com/queue/' + app.idReda;
                $.ajax({
                    method: "GET",
                    contentType: 'application/json',
                    dataType: "json",
                    cache: true,
                    url: url,
                    data: {
                        //"access_token" : localStorage.getItem("token")
                    }
                }).done(function( data ) {
                    console.log("Broj ljudi vraca:");
                    console.log(data);
                    console.log("Broj ljudi u redu " + data.name + " je " + data.priority);
                    app.brojLjudi = data.priority;
                }).fail(function(jqxhr, textStatus, error) {
                    console.log( textStatus + " " + error);
                    app.brojLjudi = 0;
                });
            }).fail(function(jqxhr, textStatus, error) {
                console.log( textStatus + " " + error);
                $(".loader").removeClass("is-active");
            });

        }
    });


    $('#footer').load('Footer.html');
    $('#navigacija').load('navigacija.html');


</script>
</body>
</html>